@page "/tanks"
@inject HttpClient Http
@inject ISnackbar Snackbar

<PageTitle>Tanks - VanDaemon</PageTitle>

<style>
    .tanks-header {
        margin-bottom: 24px;
    }

    .refresh-button {
        min-height: 48px;
        font-size: 16px;
    }

    @@media (max-width: 600px) {
        .tanks-header h3 {
            font-size: 1.75rem;
        }

        .refresh-button {
            width: 100%;
            min-height: 56px;
        }
    }
</style>

<div class="tanks-header">
    <MudText Typo="Typo.h3" GutterBottom="true">Tank Monitoring</MudText>
    <MudText Class="mb-4">Monitor water, waste, LPG, and fuel levels</MudText>

    <MudButton Variant="Variant.Filled"
               Color="Color.Primary"
               StartIcon="@Icons.Material.Filled.Refresh"
               OnClick="RefreshAll"
               Class="mb-4 refresh-button"
               Size="Size.Large">
        Refresh All Tanks
    </MudButton>
</div>

@if (tanks == null)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudGrid>
        @foreach (var tank in tanks)
        {
            <MudItem xs="12" md="6" lg="4">
                <MudCard Elevation="2">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">@tank.Name</MudText>
                            <MudChip Size="Size.Small" Color="@GetTankTypeColor(tank.Type)">@tank.Type</MudChip>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <MudIconButton Icon="@GetTankIcon(tank.Type)" Color="Color.Primary" />
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-2">
                            @tank.CurrentLevel.ToString("F1")%
                        </MudText>

                        <MudProgressLinear Color="@GetTankProgressColor(tank)"
                                         Value="@tank.CurrentLevel"
                                         Size="Size.Large"
                                         Class="my-2" />

                        <MudText Typo="Typo.body2" Class="mt-3">
                            <strong>Capacity:</strong> @tank.Capacity L
                        </MudText>
                        <MudText Typo="Typo.body2">
                            <strong>Actual:</strong> @((tank.CurrentLevel / 100 * tank.Capacity).ToString("F1")) L
                        </MudText>

                        @if (IsTankInWarningState(tank))
                        {
                            <MudAlert Severity="@GetAlertSeverity(tank)" Dense="true" Class="mt-2">
                                @GetWarningMessage(tank)
                            </MudAlert>
                        }

                        <MudText Typo="Typo.caption" Class="mt-2">
                            Last updated: @tank.LastUpdated.ToLocalTime().ToString("HH:mm:ss")
                        </MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        }
    </MudGrid>
}

@code {
    private List<TankDto>? tanks;

    protected override async Task OnInitializedAsync()
    {
        await LoadTanks();
    }

    private async Task LoadTanks()
    {
        try
        {
            var jsonOptions = new System.Text.Json.JsonSerializerOptions
            {
                PropertyNameCaseInsensitive = true,
                Converters = { new System.Text.Json.Serialization.JsonStringEnumConverter() }
            };
            tanks = await Http.GetFromJsonAsync<List<TankDto>>("api/tanks", jsonOptions);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading tanks: {ex.Message}");
            Snackbar.Add("Failed to load tanks", Severity.Error);
        }
    }

    private async Task RefreshAll()
    {
        try
        {
            var response = await Http.PostAsync("api/tanks/refresh", null);
            if (response.IsSuccessStatusCode)
            {
                await LoadTanks();
                Snackbar.Add("All tank levels refreshed", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error refreshing tanks: {ex.Message}");
            Snackbar.Add("Failed to refresh tanks", Severity.Error);
        }
    }

    private Color GetTankProgressColor(TankDto tank)
    {
        if (tank.Type == TankType.WasteWater)
        {
            return tank.CurrentLevel > tank.HighLevelThreshold ? Color.Error : Color.Info;
        }

        if (tank.CurrentLevel < tank.LowLevelThreshold)
            return Color.Error;
        if (tank.CurrentLevel < tank.LowLevelThreshold * 2)
            return Color.Warning;
        return Color.Success;
    }

    private Color GetTankTypeColor(TankType type)
    {
        return type switch
        {
            TankType.FreshWater => Color.Info,
            TankType.WasteWater => Color.Warning,
            TankType.LPG => Color.Secondary,
            TankType.Fuel => Color.Dark,
            TankType.Battery => Color.Success,
            _ => Color.Default
        };
    }

    private string GetTankIcon(TankType type)
    {
        return type switch
        {
            TankType.FreshWater => Icons.Material.Filled.WaterDrop,
            TankType.WasteWater => Icons.Material.Filled.Delete,
            TankType.LPG => Icons.Material.Filled.Propane,
            TankType.Fuel => Icons.Material.Filled.LocalGasStation,
            TankType.Battery => Icons.Material.Filled.BatteryFull,
            _ => Icons.Material.Filled.Opacity
        };
    }

    private bool IsTankInWarningState(TankDto tank)
    {
        if (tank.Type == TankType.WasteWater)
            return tank.CurrentLevel >= tank.HighLevelThreshold;

        return tank.CurrentLevel <= tank.LowLevelThreshold;
    }

    private Severity GetAlertSeverity(TankDto tank)
    {
        if (tank.Type == TankType.WasteWater)
            return tank.CurrentLevel >= 95 ? Severity.Error : Severity.Warning;

        return tank.CurrentLevel <= (tank.LowLevelThreshold / 2) ? Severity.Error : Severity.Warning;
    }

    private string GetWarningMessage(TankDto tank)
    {
        if (tank.Type == TankType.WasteWater)
            return tank.CurrentLevel >= 95 ? "Tank almost full!" : "Tank level high";

        return tank.CurrentLevel <= (tank.LowLevelThreshold / 2) ? "Tank critically low!" : "Tank level low";
    }

    public enum TankType
    {
        FreshWater,
        WasteWater,
        LPG,
        Fuel,
        Battery
    }

    public class TankDto
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public TankType Type { get; set; }
        public double CurrentLevel { get; set; }
        public double Capacity { get; set; }
        public double LowLevelThreshold { get; set; }
        public double HighLevelThreshold { get; set; }
        public DateTime LastUpdated { get; set; }
    }
}
