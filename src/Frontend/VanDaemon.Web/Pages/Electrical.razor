@page "/electrical"
@using System.Text.Json
@inject HttpClient Http
@inject TelemetryService Telemetry
@inject ISnackbar Snackbar
@implements IAsyncDisposable

<PageTitle>Electrical System - VanDaemon</PageTitle>

<style>
    .electrical-page {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: var(--mud-palette-surface);
        border-radius: 12px;
        padding: 20px;
        box-shadow: var(--mud-elevation-4);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--mud-elevation-8);
    }

    .stat-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }

    .stat-icon {
        font-size: 48px !important;
    }

    .stat-title {
        font-size: 0.875rem;
        color: var(--mud-palette-text-secondary);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 8px;
    }

    .stat-unit {
        font-size: 1.25rem;
        font-weight: 400;
        opacity: 0.7;
        margin-left: 4px;
    }

    .stat-subtitle {
        font-size: 0.875rem;
        color: var(--mud-palette-text-secondary);
        margin-top: 8px;
    }

    .battery-bar-container {
        width: 100%;
        height: 40px;
        background: var(--mud-palette-background-grey);
        border-radius: 8px;
        position: relative;
        overflow: hidden;
        border: 2px solid rgba(0, 0, 0, 0.12);
        margin-top: 12px;
    }

    [data-theme="dark"] .battery-bar-container {
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(255, 255, 255, 0.12);
    }

    .battery-bar-fill {
        height: 100%;
        transition: width 0.5s ease, background-color 0.3s ease;
        border-radius: 6px;
    }

    .battery-bar-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-weight: 700;
        font-size: 1rem;
        color: var(--mud-palette-text-primary);
        text-shadow: 0 0 4px var(--mud-palette-surface);
        z-index: 1;
    }

    .last-updated {
        text-align: center;
        color: var(--mud-palette-text-secondary);
        font-size: 0.75rem;
        margin-top: 20px;
    }

    .positive-value {
        color: #4caf50;
    }

    .negative-value {
        color: #f44336;
    }

    .neutral-value {
        color: var(--mud-palette-text-primary);
    }
</style>

<div class="electrical-page">
    <MudText Typo="Typo.h4" GutterBottom="true">
        <MudIcon Icon="@Icons.Material.Filled.BatteryChargingFull" Style="vertical-align: middle; margin-right: 8px;" />
        Electrical System
    </MudText>

    @if (electricalSystem == null)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        <MudText>Loading electrical system data...</MudText>
    }
    else
    {
        <div class="stats-grid">
            <!-- Battery State of Charge -->
            <div class="stat-card">
                <div class="stat-header">
                    <MudIcon Icon="@Icons.Material.Filled.BatteryFull" Color="@GetSocColor()" Class="stat-icon" />
                    <div style="flex: 1;">
                        <div class="stat-title">State of Charge</div>
                    </div>
                </div>
                <div class="stat-value">
                    @electricalSystem.StateOfCharge.ToString("F1")<span class="stat-unit">%</span>
                </div>
                <div class="battery-bar-container">
                    <div class="battery-bar-fill" style="width: @(electricalSystem.StateOfCharge)%; background-color: @GetSocBarColor();"></div>
                    <div class="battery-bar-text">@electricalSystem.StateOfCharge.ToString("F0")%</div>
                </div>
                @if (electricalSystem.TimeToGo > 0)
                {
                    <div class="stat-subtitle">
                        Time to empty: @FormatTimeToGo(electricalSystem.TimeToGo)
                    </div>
                }
            </div>

            <!-- Battery Voltage -->
            <div class="stat-card">
                <div class="stat-header">
                    <MudIcon Icon="@Icons.Material.Filled.Bolt" Color="Color.Warning" Class="stat-icon" />
                    <div style="flex: 1;">
                        <div class="stat-title">Battery Voltage</div>
                    </div>
                </div>
                <div class="stat-value">
                    @electricalSystem.Voltage.ToString("F2")<span class="stat-unit">V</span>
                </div>
                <div class="stat-subtitle">
                    @GetVoltageStatus(electricalSystem.Voltage)
                </div>
            </div>

            <!-- Battery Current -->
            <div class="stat-card">
                <div class="stat-header">
                    <MudIcon Icon="@Icons.Material.Filled.Power" Color="@GetCurrentColor()" Class="stat-icon" />
                    <div style="flex: 1;">
                        <div class="stat-title">Battery Current</div>
                    </div>
                </div>
                <div class="stat-value @GetCurrentClass()">
                    @Math.Abs(electricalSystem.Current).ToString("F1")<span class="stat-unit">A</span>
                </div>
                <div class="stat-subtitle">
                    @(electricalSystem.Current > 0 ? "Charging" : electricalSystem.Current < 0 ? "Discharging" : "Idle")
                </div>
            </div>

            <!-- Battery Power -->
            <div class="stat-card">
                <div class="stat-header">
                    <MudIcon Icon="@Icons.Material.Filled.ElectricBolt" Color="@GetPowerColor()" Class="stat-icon" />
                    <div style="flex: 1;">
                        <div class="stat-title">Battery Power</div>
                    </div>
                </div>
                <div class="stat-value @GetPowerClass()">
                    @Math.Abs(electricalSystem.Power).ToString("F0")<span class="stat-unit">W</span>
                </div>
                <div class="stat-subtitle">
                    @(electricalSystem.Power > 0 ? "Charging" : electricalSystem.Power < 0 ? "Load" : "Idle")
                </div>
            </div>

            <!-- Battery Temperature -->
            <div class="stat-card">
                <div class="stat-header">
                    <MudIcon Icon="@Icons.Material.Filled.Thermostat" Color="@GetTemperatureColor()" Class="stat-icon" />
                    <div style="flex: 1;">
                        <div class="stat-title">Battery Temperature</div>
                    </div>
                </div>
                <div class="stat-value">
                    @electricalSystem.Temperature.ToString("F1")<span class="stat-unit">Â°C</span>
                </div>
                <div class="stat-subtitle">
                    @GetTemperatureStatus(electricalSystem.Temperature)
                </div>
            </div>

            <!-- Solar Power -->
            <div class="stat-card">
                <div class="stat-header">
                    <MudIcon Icon="@Icons.Material.Filled.WbSunny" Color="@GetSolarColor()" Class="stat-icon" />
                    <div style="flex: 1;">
                        <div class="stat-title">Solar Power</div>
                    </div>
                </div>
                <div class="stat-value">
                    @electricalSystem.SolarPower.ToString("F0")<span class="stat-unit">W</span>
                </div>
                @if (electricalSystem.SolarPower > 0)
                {
                    <div class="stat-subtitle">
                        @electricalSystem.SolarVoltage.ToString("F1")V @@ @electricalSystem.SolarCurrent.ToString("F1")A
                    </div>
                }
                else
                {
                    <div class="stat-subtitle">No solar input</div>
                }
            </div>
        </div>

        <div class="last-updated">
            Last updated: @electricalSystem.LastUpdated.ToLocalTime().ToString("HH:mm:ss")
        </div>
    }
</div>

@code {
    private ElectricalSystemDto? electricalSystem;

    protected override async Task OnInitializedAsync()
    {
        await LoadElectricalSystem();

        // Subscribe to SignalR events
        Telemetry.ElectricalSystemUpdated += OnElectricalSystemUpdated;

        // Start SignalR connection
        await Telemetry.StartAsync();
    }

    private async Task LoadElectricalSystem()
    {
        try
        {
            var system = await Http.GetFromJsonAsync<ElectricalSystemDto>("api/electrical");
            if (system != null)
            {
                electricalSystem = system;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading electrical system: {ex.Message}");
            Snackbar.Add("Failed to load electrical system data", Severity.Error);
        }
    }

    private void OnElectricalSystemUpdated(object systemData)
    {
        try
        {
            // Deserialize the object to ElectricalSystemDto
            var json = JsonSerializer.Serialize(systemData);
            var system = JsonSerializer.Deserialize<ElectricalSystemDto>(json, new JsonSerializerOptions
            {
                PropertyNameCaseInsensitive = true
            });

            if (system != null)
            {
                electricalSystem = system;
                InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error processing electrical system update: {ex.Message}");
        }
    }

    private Color GetSocColor()
    {
        if (electricalSystem == null) return Color.Default;
        if (electricalSystem.StateOfCharge >= 80) return Color.Success;
        if (electricalSystem.StateOfCharge >= 50) return Color.Info;
        if (electricalSystem.StateOfCharge >= 20) return Color.Warning;
        return Color.Error;
    }

    private string GetSocBarColor()
    {
        if (electricalSystem == null) return "#4caf50";
        if (electricalSystem.StateOfCharge >= 80) return "#4caf50"; // Green
        if (electricalSystem.StateOfCharge >= 50) return "#2196f3"; // Blue
        if (electricalSystem.StateOfCharge >= 20) return "#ff9800"; // Orange
        return "#f44336"; // Red
    }

    private Color GetCurrentColor()
    {
        if (electricalSystem == null) return Color.Default;
        return electricalSystem.Current > 0 ? Color.Success : Color.Error;
    }

    private string GetCurrentClass()
    {
        if (electricalSystem == null) return "neutral-value";
        return electricalSystem.Current > 0 ? "positive-value" : electricalSystem.Current < 0 ? "negative-value" : "neutral-value";
    }

    private Color GetPowerColor()
    {
        if (electricalSystem == null) return Color.Default;
        return electricalSystem.Power > 0 ? Color.Success : Color.Warning;
    }

    private string GetPowerClass()
    {
        if (electricalSystem == null) return "neutral-value";
        return electricalSystem.Power > 0 ? "positive-value" : electricalSystem.Power < 0 ? "negative-value" : "neutral-value";
    }

    private Color GetTemperatureColor()
    {
        if (electricalSystem == null) return Color.Default;
        if (electricalSystem.Temperature > 35) return Color.Error;
        if (electricalSystem.Temperature > 30) return Color.Warning;
        if (electricalSystem.Temperature < 10) return Color.Info;
        return Color.Success;
    }

    private string GetTemperatureStatus(double temp)
    {
        if (temp > 35) return "High temperature!";
        if (temp > 30) return "Warm";
        if (temp < 10) return "Cold";
        return "Normal";
    }

    private Color GetSolarColor()
    {
        if (electricalSystem == null) return Color.Default;
        if (electricalSystem.SolarPower > 200) return Color.Success;
        if (electricalSystem.SolarPower > 50) return Color.Info;
        return Color.Default;
    }

    private string GetVoltageStatus(double voltage)
    {
        if (voltage >= 13.2) return "Fully charged";
        if (voltage >= 12.7) return "Good charge";
        if (voltage >= 12.2) return "Medium charge";
        if (voltage >= 11.8) return "Low charge";
        return "Critical!";
    }

    private string FormatTimeToGo(int seconds)
    {
        if (seconds <= 0) return "N/A";

        var timeSpan = TimeSpan.FromSeconds(seconds);
        if (timeSpan.TotalHours >= 24)
            return $"{timeSpan.TotalDays:F1} days";
        if (timeSpan.TotalHours >= 1)
            return $"{timeSpan.TotalHours:F1} hours";
        return $"{timeSpan.TotalMinutes:F0} minutes";
    }

    public async ValueTask DisposeAsync()
    {
        Telemetry.ElectricalSystemUpdated -= OnElectricalSystemUpdated;
        await Telemetry.StopAsync();
    }

    public class ElectricalSystemDto
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public double Voltage { get; set; }
        public double Current { get; set; }
        public double Power { get; set; }
        public double StateOfCharge { get; set; }
        public double Temperature { get; set; }
        public double ConsumedAmpHours { get; set; }
        public int TimeToGo { get; set; }
        public double SolarPower { get; set; }
        public double SolarVoltage { get; set; }
        public double SolarCurrent { get; set; }
        public double AcInputPower { get; set; }
        public double AcOutputPower { get; set; }
        public DateTime LastUpdated { get; set; }
    }
}
