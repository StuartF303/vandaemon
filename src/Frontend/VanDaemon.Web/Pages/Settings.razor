@page "/settings"
@using Microsoft.AspNetCore.Components.Forms
@inject HttpClient Http
@inject ISnackbar Snackbar

<PageTitle>Settings - VanDaemon</PageTitle>

<div style="padding: 16px;">

<style>
    .settings-header {
        margin-bottom: 24px;
    }

    .settings-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .settings-button {
        min-height: 48px;
    }

    @@media (max-width: 600px) {
        .settings-header h3 {
            font-size: 1.75rem;
        }

        .settings-actions {
            flex-direction: column;
        }

        .settings-button {
            width: 100%;
            min-height: 56px;
        }
    }
</style>

<div class="settings-header">
    <MudText Typo="Typo.h3" GutterBottom="true">Settings</MudText>
    <MudText Class="mb-8">Configure your VanDaemon system</MudText>
</div>

@if (configuration == null)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudGrid>
        <MudItem xs="12" md="6">
            <MudPaper Elevation="2" Class="pa-4">
                <MudText Typo="Typo.h6" GutterBottom="true">Van Configuration</MudText>

                <MudTextField @bind-Value="configuration.VanModel"
                             Label="Van Model"
                             Variant="Variant.Outlined"
                             Class="mb-3" />

                <MudSelect @bind-Value="configuration.VanDiagramPath"
                          Label="Select Van Diagram"
                          Variant="Variant.Outlined"
                          Class="mb-3">
                    @if (availableDiagrams != null)
                    {
                        @foreach (var diagram in availableDiagrams)
                        {
                            <MudSelectItem Value="@diagram">@diagram</MudSelectItem>
                        }
                    }
                </MudSelect>

                <MudSelect @bind-Value="configuration.ToolbarPosition"
                          Label="Toolbar Position"
                          Variant="Variant.Outlined"
                          Class="mb-3"
                          HelperText="For tablets & landscape phones. Portrait phones always use bottom toolbar.">
                    <MudSelectItem Value="@("Left")">Left Sidebar (Right-hand drive)</MudSelectItem>
                    <MudSelectItem Value="@("Right")">Right Sidebar (Left-hand drive)</MudSelectItem>
                    <MudSelectItem Value="@("Bottom")">Bottom Bar (Tablet/Desktop)</MudSelectItem>
                </MudSelect>

                <MudSelect @bind-Value="configuration.Theme"
                          Label="Theme"
                          Variant="Variant.Outlined"
                          Class="mb-3"
                          HelperText="Choose between light and dark mode">
                    <MudSelectItem Value="@("Light")">Light Mode</MudSelectItem>
                    <MudSelectItem Value="@("Dark")">Dark Mode</MudSelectItem>
                </MudSelect>

                <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">Upload Custom Van Diagram</MudText>
                <MudFileUpload T="IBrowserFile"
                              FilesChanged="OnFileSelected"
                              Accept=".png,.jpg,.jpeg,.svg">
                    <ButtonTemplate>
                        <MudButton HtmlTag="label"
                                  Variant="Variant.Filled"
                                  Color="Color.Primary"
                                  StartIcon="@Icons.Material.Filled.CloudUpload"
                                  for="@context">
                            Upload Image
                        </MudButton>
                    </ButtonTemplate>
                </MudFileUpload>

                @if (!string.IsNullOrEmpty(uploadedFileName))
                {
                    <MudText Typo="Typo.body2" Class="mt-2">
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                        Uploaded: @uploadedFileName
                    </MudText>
                }

                @if (!string.IsNullOrEmpty(configuration.VanDiagramPath))
                {
                    <MudText Typo="Typo.caption" Class="mt-2">Current: @configuration.VanDiagramPath</MudText>
                }
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudPaper Elevation="2" Class="pa-4">
                <MudText Typo="Typo.h6" GutterBottom="true">Alert Settings</MudText>

                <MudNumericField @bind-Value="configuration.AlertSettings.TankLowLevelThreshold"
                               Label="Low Level Threshold (%)"
                               Variant="Variant.Outlined"
                               Min="0"
                               Max="50"
                               Class="mb-3" />

                <MudNumericField @bind-Value="configuration.AlertSettings.TankHighLevelThreshold"
                               Label="High Level Threshold (%)"
                               Variant="Variant.Outlined"
                               Min="50"
                               Max="100"
                               Class="mb-3" />

                <MudSwitch @bind-Checked="configuration.AlertSettings.EnableAudioAlerts"
                          Label="Enable Audio Alerts"
                          Color="Color.Primary"
                          Class="mb-2" />

                <MudSwitch @bind-Checked="configuration.AlertSettings.EnablePushNotifications"
                          Label="Enable Push Notifications"
                          Color="Color.Primary" />
            </MudPaper>
        </MudItem>

        <MudItem xs="12">
            <MudPaper Elevation="2" Class="pa-4">
                <MudText Typo="Typo.h6" GutterBottom="true">System Information</MudText>

                <MudSimpleTable Striped="true">
                    <tbody>
                        <tr>
                            <td><strong>Van Model</strong></td>
                            <td>@configuration.VanModel</td>
                        </tr>
                        <tr>
                            <td><strong>Configuration ID</strong></td>
                            <td>@configuration.Id</td>
                        </tr>
                        <tr>
                            <td><strong>Last Updated</strong></td>
                            <td>@configuration.LastUpdated.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")</td>
                        </tr>
                        <tr>
                            <td><strong>API Endpoint</strong></td>
                            <td>@Http.BaseAddress</td>
                        </tr>
                    </tbody>
                </MudSimpleTable>
            </MudPaper>
        </MudItem>

        <MudItem xs="12">
            <div class="settings-actions">
                <MudButton Variant="Variant.Filled"
                          Color="Color.Primary"
                          Size="Size.Large"
                          StartIcon="@Icons.Material.Filled.Save"
                          OnClick="SaveSettings"
                          Class="settings-button">
                    Save Settings
                </MudButton>

                <MudButton Variant="Variant.Outlined"
                          Color="Color.Default"
                          Size="Size.Large"
                          StartIcon="@Icons.Material.Filled.Refresh"
                          OnClick="LoadSettings"
                          Class="settings-button">
                    Reload
                </MudButton>
            </div>
        </MudItem>
    </MudGrid>
}

</div>

@code {
    private SystemConfigurationDto? configuration;
    private List<string>? availableDiagrams;
    private string uploadedFileName = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadSettings();
        await LoadAvailableDiagrams();
    }

    private async Task OnFileSelected(IBrowserFile file)
    {
        if (file == null) return;

        try
        {
            // Max file size: 5MB
            var maxFileSize = 5 * 1024 * 1024;

            using var content = new MultipartFormDataContent();
            var fileContent = new StreamContent(file.OpenReadStream(maxFileSize));
            fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(file.ContentType);
            content.Add(fileContent, "file", file.Name);

            var response = await Http.PostAsync("api/settings/upload-diagram", content);
            if (response.IsSuccessStatusCode)
            {
                var uploadedPath = await response.Content.ReadAsStringAsync();
                uploadedFileName = file.Name;

                if (configuration != null)
                {
                    configuration.VanDiagramPath = uploadedPath.Trim('"');
                }

                Snackbar.Add("Diagram uploaded successfully", Severity.Success);
                await LoadAvailableDiagrams();
            }
            else
            {
                Snackbar.Add("Failed to upload diagram", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error uploading file: {ex.Message}");
            Snackbar.Add($"Upload failed: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadSettings()
    {
        try
        {
            configuration = await Http.GetFromJsonAsync<SystemConfigurationDto>("api/settings");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading settings: {ex.Message}");
            Snackbar.Add("Failed to load settings", Severity.Error);
        }
    }

    private async Task LoadAvailableDiagrams()
    {
        try
        {
            availableDiagrams = await Http.GetFromJsonAsync<List<string>>("api/settings/van-diagrams");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading diagrams: {ex.Message}");
        }
    }

    private async Task SaveSettings()
    {
        if (configuration == null) return;

        try
        {
            var response = await Http.PutAsJsonAsync("api/settings", configuration);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Settings saved successfully", Severity.Success);
                await LoadSettings();
            }
            else
            {
                Snackbar.Add("Failed to save settings", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving settings: {ex.Message}");
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    public class SystemConfigurationDto
    {
        public Guid Id { get; set; }
        public string VanModel { get; set; } = string.Empty;
        public string VanDiagramPath { get; set; } = string.Empty;
        public string ToolbarPosition { get; set; } = "Left";
        public string Theme { get; set; } = "Light";
        public AlertSettingsDto AlertSettings { get; set; } = new();
        public DateTime LastUpdated { get; set; }
    }

    public class AlertSettingsDto
    {
        public double TankLowLevelThreshold { get; set; }
        public double TankHighLevelThreshold { get; set; }
        public bool EnableAudioAlerts { get; set; }
        public bool EnablePushNotifications { get; set; }
    }
}
