@page "/"
@inject HttpClient Http
@inject TelemetryService Telemetry
@implements IAsyncDisposable

<PageTitle>Dashboard - VanDaemon</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">Dashboard</MudText>
<MudText Class="mb-8">Welcome to the VanDaemon Camper Van Control System</MudText>

<MudGrid>
    <MudItem xs="12" md="8">
        <MudPaper Elevation="2" Class="pa-4" Style="min-height: 400px;">
            <MudText Typo="Typo.h5" GutterBottom="true">Van Diagram</MudText>
            <MudText Typo="Typo.body2" Class="mb-4">Interactive van control interface coming soon...</MudText>

            <!-- Placeholder for van diagram -->
            <div style="text-align: center; padding: 50px; background: #f5f5f5; border-radius: 8px;">
                <MudIcon Icon="@Icons.Material.Filled.DirectionsCar" Size="Size.Large" Style="font-size: 120px; color: #ccc;" />
                <MudText Typo="Typo.h6" Class="mt-4">Mercedes Sprinter LWB</MudText>
            </div>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="4">
        <MudPaper Elevation="2" Class="pa-4 mb-4">
            <MudText Typo="Typo.h6" GutterBottom="true">Quick Status</MudText>
            @if (tanks == null)
            {
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            }
            else
            {
                @foreach (var tank in tanks)
                {
                    <div class="mb-3">
                        <MudText Typo="Typo.body2">@tank.Name</MudText>
                        <MudProgressLinear Color="@GetTankColor(tank)" Value="@tank.CurrentLevel" Class="my-1" />
                        <MudText Typo="Typo.caption">@tank.CurrentLevel.ToString("F1")%</MudText>
                    </div>
                }
            }
        </MudPaper>

        <MudPaper Elevation="2" Class="pa-4">
            <MudText Typo="Typo.h6" GutterBottom="true">System Status</MudText>
            <MudChip Color="@(Telemetry.IsConnected ? Color.Success : Color.Warning)"
                    Icon="@(Telemetry.IsConnected ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.CloudOff)">
                @(Telemetry.IsConnected ? "Connected" : "Connecting...")
            </MudChip>
            <MudText Typo="Typo.caption" Class="mt-2">Last update: @lastUpdateTime</MudText>
            @if (Telemetry.IsConnected)
            {
                <MudText Typo="Typo.caption" Color="Color.Success">Real-time updates active</MudText>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private List<TankDto>? tanks;
    private string lastUpdateTime = DateTime.Now.ToString("HH:mm:ss");

    protected override async Task OnInitializedAsync()
    {
        await LoadTanks();

        // Subscribe to SignalR events
        Telemetry.TankLevelUpdated += OnTankLevelUpdated;

        // Start SignalR connection
        await Telemetry.StartAsync();
    }

    private async Task LoadTanks()
    {
        try
        {
            tanks = await Http.GetFromJsonAsync<List<TankDto>>("api/tanks");
            lastUpdateTime = DateTime.Now.ToString("HH:mm:ss");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading tanks: {ex.Message}");
        }
    }

    private void OnTankLevelUpdated(Guid tankId, double level, string name)
    {
        if (tanks != null)
        {
            var tank = tanks.FirstOrDefault(t => t.Id == tankId);
            if (tank != null)
            {
                tank.CurrentLevel = level;
                lastUpdateTime = DateTime.Now.ToString("HH:mm:ss");
                InvokeAsync(StateHasChanged);
            }
        }
    }

    private Color GetTankColor(TankDto tank)
    {
        if (tank.Type == "WasteWater")
        {
            return tank.CurrentLevel > tank.HighLevelThreshold ? Color.Error : Color.Info;
        }

        return tank.CurrentLevel < tank.LowLevelThreshold ? Color.Error : Color.Success;
    }

    public async ValueTask DisposeAsync()
    {
        Telemetry.TankLevelUpdated -= OnTankLevelUpdated;
        await Telemetry.StopAsync();
    }

    public class TankDto
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Type { get; set; } = string.Empty;
        public double CurrentLevel { get; set; }
        public double Capacity { get; set; }
        public double LowLevelThreshold { get; set; }
        public double HighLevelThreshold { get; set; }
    }
}
